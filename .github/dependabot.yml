# .github/dependabot.yml
# Конфигурация Dependabot для репозитория Rarog
# Автор: TheSkiF4er
#
# Цели:
# - Автоматически отслеживать обновления зависимостей для всех используемых экосистем
# - Приоритетные security-обновления — ежедневно
# - Регулярные обновления — еженедельно (с группировкой по package-ecosystem + directory)
# - Автоматическое слияние безопасных non-major обновлений (patch/minor) при соблюдении условий CI
# - Применима для монорепо: root и packages/*
#
version: 2
updates:
  # 1) Node / pnpm (root и пакеты)
  - package-ecosystem: "npm"
    directory: "/"                       # корень (root package.json)
    schedule:
      interval: "weekly"
      day: "monday"
      time: "03:00"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 10
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"
    # Security updates handled separately below (dependabot по умолчанию открывает security PRs)
    labels:
      - "dependencies"
      - "automerge:enabled"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"
    commit-message:
      prefix: "chore(deps)"
    ignore:
      # Игнорируем обновления старого major, требующие ручной миграции (пример)
      - dependency-name: "webpack"
        update-types: ["version-update:semver-major"]

  - package-ecosystem: "npm"
    directory: "/packages/*"              # все подпакеты монорепо
    schedule:
      interval: "weekly"
      day: "monday"
      time: "04:00"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 20
    labels:
      - "dependencies"
      - "automerge:enabled"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"
    commit-message:
      prefix: "chore(deps)"

  # 2) GitHub Actions (workflows)
  - package-ecosystem: "github-actions"
    directory: "/" 
    schedule:
      interval: "daily"
      time: "02:30"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 5
    labels:
      - "ci"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"

  # 3) Docker images (Dockerfile references)
  - package-ecosystem: "docker"
    directory: "/"                        # ищет Dockerfile в репозитории
    schedule:
      interval: "weekly"
      day: "wednesday"
      time: "03:30"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 5
    labels:
      - "docker"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"
    registries:
      # если используете приватные регистры, добавьте их в Dependabot settings и укажите здесь:
      # - name: "ghcr"
      #   type: "github-container-registry"
      #   url: "https://ghcr.io"

  # 4) Terraform (infra)
  - package-ecosystem: "terraform"
    directory: "/infra/terraform"
    schedule:
      interval: "weekly"
      day: "tuesday"
      time: "05:00"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 5
    labels:
      - "infra"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"

  # 5) Go modules
  - package-ecosystem: "gomod"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "thursday"
      time: "03:00"
      timezone: "Europe/Berlin"
    labels:
      - "go"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"

  # 6) Python (pip / requirements.txt / pyproject)
  - package-ecosystem: "pip"
    directory: "/" 
    schedule:
      interval: "weekly"
      day: "friday"
      time: "03:00"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 5
    labels:
      - "python"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"

  # 7) PHP (composer)
  - package-ecosystem: "composer"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "friday"
      time: "04:00"
      timezone: "Europe/Berlin"
    open-pull-requests-limit: 5
    labels:
      - "php"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"

  # 8) Java (maven/gradle)
  - package-ecosystem: "gradle"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "wednesday"
      time: "04:30"
      timezone: "Europe/Berlin"
    labels:
      - "java"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"

  - package-ecosystem: "maven"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "wednesday"
      time: "04:30"
      timezone: "Europe/Berlin"
    labels:
      - "java"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"

  # 9) Ruby (bundler)
  - package-ecosystem: "bundler"
    directory: "/"
    schedule:
      interval: "weekly"
      day: "tuesday"
      time: "04:30"
      timezone: "Europe/Berlin"
    labels:
      - "ruby"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"

# Дополнительные глобальные опции
# Security updates: Dependabot автоматически создаёт PR для security alerts.
# Мы явно включаем ежедневную проверку security для npm и github-actions
  - package-ecosystem: "npm"
    directory: "/"
    schedule:
      interval: "daily"
      time: "01:00"
      timezone: "Europe/Berlin"
    allow:
      - dependency-type: "direct"
      - dependency-type: "indirect"
    labels:
      - "security"
      - "dependencies"
    reviewers:
      - "TheSkiF4er"
    assignees:
      - "TheSkiF4er"
    # Включаем автоматические security PR как отдельный update (dependabot всё равно откроет security PR)

# Политика автоматического слияния (automerge)
# Примечание: automerge в dependabot.yml поддерживается в формате automerged_updates.
# GitHub может требовать дополнительных настроек (branch protection, required checks).
automerged_updates:
  enabled: true
  # merge_method: "squash" | "merge" | "rebase"
  merge_method: "squash"
  # Условия автослияния: только для patch/minor (non-major) и если все required CI checks прошли
  # Dependabot автоматически не будет автосливать major updates
  # (зависит от настроек репозитория — убедитесь, что Branch protection настроен корректно)
  commit-message:
    prefix: "chore(deps)"
  # Дополнительные правила автослияния
  allow:
    - dependency-type: "direct"
    - dependency-type: "indirect"
  ignore:
    - update-types: ["version-update:semver-major"]

# Рекомендации и комментарии:
# 1) Для приватных регистров (их много для корпоративных контейнеров / npm), добавьте их в Settings → Dependabot → registries и укажите здесь registry name.
# 2) Для каждого package-ecosystem можно менять directory, если у вас специфичные подпакеты (например, /packages/core, /packages/react).
# 3) Для безопасного автослияния убедитесь, что в Branch protection для ветки main включены required checks (lint, build, test, security), чтобы Dependabot PR автоматически проходил gate.
# 4) Можете настроить `versioning-strategy: increase` или `widen` для некоторых экосистем, если хотите агрессивнее обновлять версии.
# 5) При необходимости добавьте `ignore` для библиотек с частыми breaking changes, или укажите `target-branch` для PR.
#
# Конец файла
