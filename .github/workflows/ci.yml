# .github/workflows/ci.yml
# CI pipeline для monorepo Rarog
# Автор: TheSkiF4er
# Назначение: lint, typecheck, build, test, stylelint, security scan, a11y checks, отчёты о покрытии

name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  setup:
    name: Подготовка окружения
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node and pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Cache pnpm store
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ~/.cache/pnpm
            **/node_modules
            **/.pnpm
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        if: steps.cache.outputs.cache-hit != 'true'
        run: pnpm install --frozen-lockfile

      - name: Install (cached)
        if: steps.cache.outputs.cache-hit == 'true'
        run: pnpm install --frozen-lockfile --offline || pnpm install --frozen-lockfile

  lint:
    name: Lint / Format / Style
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm -w run lint

      - name: Run Stylelint
        run: pnpm -w run lint:css || true

      - name: Check formatting (Prettier)
        run: pnpm -w run format:check

  typecheck:
    name: TypeScript typecheck
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Run TypeScript project build (tsc -b)
        run: pnpm -w run typecheck

  build:
    name: Сборка пакетов
    runs-on: ubuntu-latest
    needs: [setup, lint, typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
            packages/**/dist
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}-build
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Build all (turbo)
        run: pnpm -w run build --parallel
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rarog-dist
          path: |
            packages/**/dist
            docs/.docusaurus/build || true

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        package: [ 'packages/core', 'packages/js', 'packages/react' ]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Run tests for ${{ matrix.package }}
        working-directory: ${{ matrix.package }}
        run: |
          if [ -f package.json ]; then pnpm test --reporter=jest-junit || pnpm test || true; else echo "no package.json"; fi
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.package }}
          path: ${{ matrix.package }}/test-results || .

  security-scan:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Run dependency scan (npm audit)
        run: pnpm -w audit --audit-level=moderate || true
      - name: Trivy image scan (if Dockerfile present)
        if: fileExists('Dockerfile')
        uses: aquasecurity/trivy-action@v1
        with:
          image-ref: 'rarog:ci-latest' # Этот шаг предусмотрен для проектов, где собирается образ

  accessibility:
    name: A11Y checks (axe)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Start docs server (background)
        run: |
          pnpm --filter docs dev &
          sleep 5
      - name: Run axe-core checks (sample pages)
        run: pnpm --filter docs test:a11y || true

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Collect coverage and upload
        run: |
          pnpm -w run coverage:collect || true
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage || .

  notify:
    name: Отчет и уведомления
    runs-on: ubuntu-latest
    needs: [lint, build, test, security-scan, accessibility]
    steps:
      - name: Create summary
        run: |
          echo "Build completed for $GITHUB_REPOSITORY - $GITHUB_REF" > summary.txt
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: summary.txt

# Примечания:
# - Этот workflow ориентирован на PR и push в main. Для автоматической публикации в npm и деплоя рекомендуем отдельный release workflow,
#   который использует semantic-release и триггерится только на push в main с корректными тегами.
# - Некоторые шаги (Trivy, a11y, playwrigh e2e) предполагают наличие соответствующих скриптов в package.json каждого пакета.
# - Используйте GitHub Organization secrets (NPM_TOKEN, DOCKERHUB_TOKEN, SNYK_TOKEN) в release workflow, не помещайте их в CI.yml.
